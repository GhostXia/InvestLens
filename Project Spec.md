
---

## 项目规格说明书 — InvestLens (Vibe Coding 版)

### 1. 项目意图

InvestLens 是一个开源的**投资决策支持工具**，专注于分析用户选择的金融产品（如股票、基金、ETF 等），提供参考级的投资分析、同类对比和优化建议，而**非交易系统**。

为保留未来可扩展性，本项目预留了**分析层与潜在执行层之间的接口规范**，但**当前及未来版本均不包含任何交易执行功能**。

其输出旨在**降低认知负荷**、**揭示权衡利弊**并**提升理解力**，而非发出买入/卖出指令。

---

### 2. 条件性量化能力 (需主动开启)

默认情况下，系统处于“分析模式”，专注于辅助理解。

用户可以通过**显式确认风险条款**开启“量化模式”。在此模式下，系统**可以**：

*   提供基于数据的买入/卖出/持有信号参考
*   展示基于模型的概率性价格预测
*   执行以利润/回报率为目标的投资组合优化建议

**关键约束**：这些功能必须被“风险墙”隔离，确保用户在能够接收此类信息前已充分知晓量化交易的风险。

#### 2.1 预测性 K 线 (Predictive K-Line)
*   **功能描述**: 利用时间序列模型 (如 LSTM, Transformer) 或大模型推演，在现有 K 线图之后绘制未来的虚线趋势。
*   **展示方式**: 必须使用**虚线**或**不同色系**与历史真实数据进行严格区分，并标注“AI 预测推演”字样。
*   **视觉隔离**: 预测区间必须伴随显眼的**置信区间 (Confidence Band)** 阴影，直观展示预测的不确定性范围。

---

### 3. 核心能力

#### 3.1 资产分析

给定金融产品标识符和元数据，系统应：

*   总结关键特征（类型、类别、区域、行业、风格）
*   分析历史行为（波动性、回撤、相关性）
*   识别主要风险因素（市场、行业、货币、集中度）

输出应是**描述性的，而非规定性的**。

---

#### 3.2 同类比较

对于给定资产，系统可以：

*   识别可比较的产品（相同类别或敞口）
*   强调相似点和不同点
*   解释权衡（成本、风险状况、多元化作用）

不按“最好”或“最差”进行排名。

---

#### 3.3 投资组合背景 (可选)

如果提供了多个资产：

*   分析多元化和重叠情况
*   检测集中度风险
*   提供**优化参考**（例如“考虑减少重叠”、“敞口似乎不平衡”）

建议必须构建为**参考**，而非行动指令。

---

### 4. 信息源策略

系统应采用分级信息采集策略，以确保数据的准确性与广度：

#### 4.1 权威核心源 (默认锁定)
*   系统预置并锁定一组高可信度的权威信息源（如 Bloomberg, Morningstar, 交易所官方网站, 监管机构公告）。
*   此类信息源作为基准数据，具有最高优先级。

#### 4.2 动态产品源 (上下文感知)
*   根据用户选择的具体投资标的，系统自动识别并纳入该产品的官方渠道（如上市公司官网、基金发行方主页）。
*   确保获取该标的的第一手披露信息。

#### 4.3 用户自定义源 (可扩展)
*   用户可自行添加信任的 URL 或 RSS 源。
*   AI 将这些源纳入参考范围，但需在分析中注明数据来源，并对其可信度进行潜在的交叉验证。

---

### 5. 输出风格指南

所有生成的内容应：

*   使用中立、分析性的语言
*   避免祈使动词（“买入”、“卖出”、“应该”）
*   包含体现不确定性的措辞（“可能”、“倾向于”、“历史上”）
*   优先考虑清晰度而非耍小聪明

基调：冷静、理性、专业。

---

### 6. 解释优先原则

对于每一条洞察或建议：

*   解释**为什么**存在
*   引用可观察到的特征（风险、相关性、结构）
*   避免晦涩或纯模型驱动的结论

系统应表现得像一位**透明的分析师**，而不是一个黑盒子。

---

### 7. 架构建议 (非强制)

建议的概念模块：

*   资产解析器 (Asset Parser)
*   特征提取器 (Feature Extractor)
*   相似性引擎 (Similarity Engine)
*   风险与敞口分析器 (Risk & Exposure Analyzer)
*   洞察生成器 (Insight Generator)
*   **多模型共识编排器 (Consensus Orchestrator)**
*   护栏层 (语言与合规过滤器)

#### 7.1 实时性适配 (Real-Time Readiness)
若要支持 API 交易功能，架构需进行从“静态分析”到“动态交易”的适配：

*   **数据接入**: 必须从轮询 (HTTP Polling) 升级为 **WebSocket/SSE 流式接入**，以捕获毫秒级市场变动。
*   **执行环境**: 建议引入有状态服务 (Stateful Service, 如 Go/Rust/Node.js 常驻进程) 托管交易逻辑，避免 Serverless (Next.js API) 的冷启动延迟。
*   **时序精度**: 必须在数据入口处 (Ingress) 立即打上纳秒/微秒级时间戳，确保回测与实盘的时间轴一致。

实现细节是灵活的。

---

### 8. 多模型共识引擎 (Multi-Model Consensus Engine)

为了降低单一模型的“幻觉”风险并提供更客观的视角，系统应实现“LLM-as-a-Judge”共识机制。

#### 8.1 工作流定义
1.  **并行生成**: 针对同一分析指令，分别调用 DeepSeek, ChatGPT, Gemini 等不同架构的模型生成独立的投资分析意见。
2.  **匿名化层**: 去除所有模型特定的标识符，将输出标准化为统一格式。
3.  **对抗性评审**: 将匿名化的三份方案重新分发给所有模型，要求它们从逻辑严密性、数据支持度、风险意识等维度进行互评打分。
4.  **优选与输出**: 系统自动选择得分最高的方案作为最终输出，或生成一份融合了各方通过评审观点的综合报告。

#### 8.2 多维评分标准
*   **逻辑自洽性**: 论据是否能推导出结论。
*   **数据引用**: 是否有效利用了提供的上下文数据。
*   **风险揭示**: 是否充分指出了潜在的下行风险。

#### 8.3 模型接入标准 (Model Integration Standard)
为了确保系统的兼容性与长期可维护性，所有外部 AI 服务必须遵循统一的接口规范：

*   **协议标准**: 当前以 **OpenAI Chat Completion API** 格式为核心标准。
*   **接入方式**:
    *   用户可在设置中配置 `Base URL` 和 `API Key`。
    *   原生支持 OpenAI 官方接口。
    *   支持通过标准格式接入 DeepSeek, Moonshot, OpenRouter 等第三方服务。
    *   支持接入本地模型 (如 Ollama, LM Studio)，地址通常为 `http://localhost:11434/v1`。
*   **扩展性说明 (Extensibility)**: 虽然当前版本仅预置 OpenAI 格式支持，但架构保留了**完全的接口扩展性**。高级用户或开发者可自行修改适配层代码，以兼容 Google Gemini 原生 API、Anthropic SDK 等其他非标准格式。

---

### 9. 护栏与安全

系统应根据当前模式实施分级护栏：

#### 9.1 标准分析模式 (默认)
*   严格拒绝明确的投资建议。
*   将预测性语言降级为通过历史数据描述。

#### 9.2 量化增强模式
*   允许生成交易信号和预测，但必须伴随**置信度区间**和**风险提示**。
*   界面必须有明显的视觉标识（如红色边框或特定图标），提醒用户当前处于高风险模式。
*   所有的信号输出必须包含：“此结果仅基于特定模型生成，历史表现不代表未来收益。”

免责声明示例：

> 本工具仅提供分析性洞察以供参考，不构成投资建议。

---

### 10. 扩展性

项目设计应支持：

*   多种资产类型
*   不同的数据源
*   未来的分析模块

倾向于模块化、可组合的设计。

---

### 11. 许可与理念

*   许可证：MIT
*   默认开放，设计上可组合
*   专注于**行动前的理解**

---

### 12. Vibe Coding 实施计划

本节概述了使用现代 AI 辅助工作流构建 InvestLens 的策略。

#### 12.1 核心理念
*   **AI 原生 (AI-Native)**: 利用 LLM 生成 UI 组件、重构代码和编写测试。开发者专注于架构和逻辑审查。
*   **极速迭代 (Rapid Iteration)**: 这里的 "Vibe" 指的是开发的心流状态。通过快速的原型设计和即时反馈循环，保持开发的高效与愉悦。
*   **视觉优先 (Visual-First)**: 优先构建高保真的前端界面，让功能“看得见”，以此驱动后端逻辑的实现。

#### 12.2 平台策略 (Platform Strategy)
*   **Web First (桌面网页优先)**: 
    *   鉴于金融分析需要高密度的信息展示（复杂的相关性矩阵、多维 K 线图、详细的对比报表），桌面端浏览器是最佳载体。
    *   **移动端策略**: 采用响应式设计支持移动端查看，但核心深度分析功能针对大屏优化。不单独开发原生 App。

#### 12.3 技术栈选择 (分离式全栈架构)

为了平衡“极速 UI 开发”与“高性能量化计算”，采用前后端分离架构：

**A. 应用层 (Frontend Layer)** - *负责 UI/UX 与 基础业务逻辑*
*   **框架**: [Next.js](https://nextjs.org/) (App Router)
*   **语言**: TypeScript, Tailwind CSS, Shadcn UI
*   **状态管理**: Zustand
*   **理由**: AI 生成 UI 的效率最高，React 生态图表库丰富。

**B. 量化内核 (Quant Kernel)** - *负责 信号生成、回测与流式计算*
*   **核心语言**: **Python** (推荐)
*   **Web 框架**: **FastAPI** (支持高性能 AsyncIO WebSocket)
*   **关键库**: Pandas, NumPy, TA-Lib, PyTorch (可选)
*   **理由**: Python 是量化金融的绝对标准。相比 Node.js，它拥有不可替代的数学计算与数据分析生态。AI 编写 Python 数据清洗与策略脚本的能力极强。
*   **注意**: 本内核目前仅实现**数据分析与信号生成**。涉及实盘交易执行的逻辑仅作接口预留，不包含在任意版本中。

**C. 通信层**
*   **实时数据**: WebSocket / gRPC流
*   **常规交互**: RESTful API
*   **注意**: 交易指令发送通道仅为**预留接口标准**，本项目不实现对接交易所的下单功能。

#### 12.4 开发工作流
1.  **脚手架搭建**: 使用 `create-next-app` 初始化项目，配置 Tailwind 和 Shadcn UI。
2.  **组件生成**: 针对每个核心功能（如“资产分析卡片”、“风险图表”），使用 AI 生成初始 UI。
3.  **交互实现**: 逐步添加交互逻辑，连接模拟数据 (Mock Data)。
4.  **逻辑接入**: 替换模拟数据为真实的分析逻辑或 API 调用。
5.  **护栏集成**: 将“非目标”和“安全护栏”作为 Review 准则，确保所有 AI生成的代码符合规范。

此计划旨在利用 AI 的编码能力，最大化开发效率，同时保持代码的清晰度和可维护性。

#### 12.5 模块化开发策略 (Modular Development Strategy)
为了提升代码的可维护性与 AI 辅助编程的准确性，必须遵循以下原则：

1.  **特性优先架构 (Feature-First Architecture)**:
    *   代码应按“业务特性”而非“技术类型”组织。
    *   例如：`features/market-kline` (包含该功能相关的组件、Hooks、API请求)，而非将文件散落在 `components` 和 `hooks` 两个远离的文件夹中。
    *   理由：为 AI 提供完整的上下文（Context），减少跨文件查找错误。

2.  **原子化组件 (Atomic UI Components)**:
    *   遵循 Shadcn 哲学，组件应是自包含的、可复制粘贴的实体。
    *   严禁创建“万能组件”，每个组件只把一件小事做好。

3.  **微内核后端 (Micro-Kernel Backend)**:
    *   Python 量化内核应由无状态的**计算插件 (Plugins)** 组成。
    *   每个分析模型（如“动量策略”、“波动率分析”）应是独立的 Python 模块，通过统一接口注册到系统。

---

### 13. 交易接口开发前置 (Trading API Development Prerequisites)

为了赋予项目未来的可扩展性，本规范定义了“分析层”与潜在“执行层”之间的标准通信接口。

#### 13.1 信号流标准 (Signal Stream/Event Schema)
系统应能够通过标准 JSON 格式输出分析结论，供外部系统订阅。这仅作为数据输出，不包含执行逻辑。

```json
{
  "event_type": "quant_signal",
  "timestamp": "ISO8601_UTC",
  "data": {
    "asset_id": "Ticker/ISIN",
    "signal_direction": "LONG/SHORT/NEUTRAL",
    "confidence_score": 0.85,
    "rationale_summary": "基于动量因子与宏观情绪的共振...",
    "risk_factors": ["High Volatility", "Earnings Week"]
  }
}
```

#### 13.2 系统边界定义
*   **InvestLens 的职责**: 也就是作为“大脑”，负责接收数据、处理信息、生成带概率的判断。
*   **外部系统的职责**: 也就是作为“手脚”，负责账户管理、订单路由、资金划转等实际操作。InvestLens **不**包含这些功能。

#### 13.3 开发者免责声明 (Author's Disclaimer)

> **重要声明 / IMPORTANT NOTICE**
>
> 1.  本规范提供的接口定义仅为了架构的完整性与可扩展性。
> 2.  **作者本人不会开发、维护或提供任何基于本软件的“自动化交易执行系统”或“实盘下单模块”。**
> 3.  任何用户利用本软件的输出接口对接自行开发的交易系统，均属于用户个人行为。作者不对任何实盘交易的损益、系统延迟或执行故障承担责任。

---

### 14. 数据隐私与安全 (Data Privacy & Security)

鉴于本系统涉及金融敏感数据及第三方 AI 服务，必须严格遵守以下隐私原则：

#### 14.1 本地优先密钥 (Local-First Keys)
*   所有的敏感凭证（如 OpenAI API Key, 交易所 Access Token）必须仅存储在用户本地环境（浏览器 LocalStorage 或本地 `.env` 文件）。
*   严禁将密钥上传至任何中心化服务器或云端数据库。

#### 14.2 AI 交互脱敏 (LLM Sanitization)
*   在将投资组合数据发送给“多模型共识引擎”之前，系统必须执行脱敏处理。
*   **金额归一化**: 建议将绝对金额转换为百分比（如“持仓 100万美元” -> “仓位 20%”），避免向 LLM 泄露用户真实资产规模。
*   **PII 过滤**: 自动剔除任何账户 ID、用户名等个人身份信息。

---

### 15. 部署与运维 (Deployment & Operations)

为了简化“分离式全栈架构”的交付难度，推荐采用容器化部署：

#### 15.1 标准交付方式
系统提供标准的 `docker-compose.yml` 文件，一键拉起以下容器组：
1.  **investlens-web**: Next.js 前端容器 (Port 3000)
2.  **investlens-kernel**: Python 量化内核容器 (Port 8000)
3.  **investlens-cache**: Redis 缓存（用于高速信号交换）

#### 15.2 自托管定位
本项目定位为 **Self-Hosted (自托管)** 软件。用户拥有数据的完全所有权，同时也需自行承担服务器运维与网络连通性的责任。

---

### 16. 文档与进度管理 (Documentation & Lifecycle Management)

为了防止项目文档腐烂 (Documentation Drift) 并确保开发透明度，必须执行以下强制性标准：

#### 16.1 外置 Wiki (Developer Manual)
*   **文件位置**: 必须建立独立的 `docs/wiki.md` 或直接使用 GitHub Wiki。
*   **单一真实来源 (Single Source of Truth)**: 该文档是所有开发工作的最高准则。
*   **内容要求**:
    *   **全接口定义**: 包含所有 REST API 和 WebSocket 信号的完整 JSON Schema。
    *   **调用示例**: 为每个核心功能提供 Python/cURL 调用代码片段。
*   **同步规则**: 任何代码变更如果涉及接口调整，**必须先更新 Wiki，再修改代码**。

#### 16.2 强制进度日志 (Mandatory Progress Log)
*   **文件位置**: 项目根目录下必须包含 `PROGRESS.md`。
*   **无日志不提交原则**: 每次开发会话结束前，开发者**必须**更新此文档。
*   **记录格式**:
    *   `[YYYY-MM-DD]` - **变更摘要**
    *   `DONE`: 已完成的特性点。
    *   `TODO`: 下一步的明确计划。
    *   `BLOCKER`: 当前遇到的阻碍。

#### 16.3 代码注释规范 (Code Commenting Standard)
*   **强制英文注释 (Mandatory English Comments)**: 所有的程序源文件（.tsx, .ts, .py）必须使用**英文**编写详细注释。
*   **覆盖范围**: 包括函数文档字符串 (Docstrings)、复杂逻辑的行内解释以及类型定义说明。目标是让非中文母语的开发者（及 AI）也能无障碍理解代码意图。

---

### 17. 成本控制与资源约束 (Cost & Resource Management)

鉴于“多模型共识”和“高频分析”的高昂成本，系统必须内置资源管理模块：

#### 17.1 分级分析机制 (Tiered Analysis)
*   **ECO Mode (日常)**: 仅调用单一大模型（如 GPT-4o-mini 或 Gemini-Flash）进行快速扫描。
*   **PRO Mode (深度)**: 仅在用户显式要求时，激活包含 DeepSeek R1 + ChatGPT + Gemini 的“共识引擎”，并消耗额外的 Token 预算。

#### 17.2 熔断机制
*   必须允许用户设置“每日 API 消费上限”（例如 $5.00/天）。
*   一旦达到上限，系统应自动降级为仅使用本地缓存数据或免费模型，拒绝昂贵的外部调用。

---

### 18. 测试与质量保证 (Testing & QA Standards)

在金融领域，AI 生成的代码必须经过比普通软件更严苛的验证：

#### 18.1 量化内核测试要求
*   **覆盖率红线**: `investlens-kernel` (Python) 的核心计算模块（收益率计算、回撤分析）单元测试覆盖率必须 **> 85%**。
*   **数值对照**: 必须包含与 TA-Lib 或 Pandas 标准库结果比对的基准测试 (Benchmark Tests)。

#### 18.2 AI 生成代码规范
*   当使用 Vibe Coding 流程让 AI 生成新功能时，必须提示 AI **“同时生成对应的单元测试”**。
*   无测试的代码严禁合并入主分支。

