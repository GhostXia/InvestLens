# InvestLens 项目审查评估、优化方案与未来开发计划（2026-02）

> **文档版本**: v1.1 | **最后更新**: 2026-02-07 | **状态**: 活跃迭代中

## 1. 执行摘要

InvestLens 已完成 MVP 闭环：前端（Next.js）具备行情展示、分析、设置、观察列表等核心页面；后端（FastAPI）具备报价、基本面、分析（同步 + SSE）、聊天等端点。当前系统已经具备"可演示、可扩展、可快速迭代"的基础，但在**可维护性、可靠性、合规安全、性能与工程化治理**方面仍有明显提升空间。

### 1.1 近期已完成功能 ✅

| 功能 | 完成时间 | 关键文件 |
|------|----------|----------|
| 国际化支持 (i18n) | 2026-02-07 | `i18n/config.ts`, `messages/*.json` |
| AI投资顾问 (Portfolio Advisor) | 2026-02-06 | `portfolio_advisor.py`, `PortfolioAdvisor.tsx` |
| 多市场扩展 (港股/加密货币) | 2026-02-06 | `README.md` 架构图更新 |
| 分析页面功能扩展 | 2026-02-06 | 分析模块增强 |

### 1.2 迭代目标分层

建议将未来迭代分为三层目标：

| 优先级 | 时间范围 | 核心目标 | 团队投入建议 |
|--------|----------|----------|--------------|
| **P0** | 2~4 周 | 稳定性与安全基线 | 全力投入 |
| **P1** | 1~2 个月 | 性能优化与工程规范 | 70% 产能 |
| **P2** | 1~2 个季度 | 产品化与规模化 | 按需规划 |

---

## 2. 项目现状评估

### 2.1 架构与能力
- 双端架构清晰：前端 Next.js + 后端 FastAPI，接口分层明确，便于并行开发。
- 分析能力突出：包含 Bull/Bear/Judge 三阶段共识流程，且支持 SSE 流式展示。
- 数据覆盖较全：yfinance + AkShare + DuckDuckGo 搜索上下文，满足多市场基础分析。

### 2.2 工程实现观察（关键）

#### A. 后端路由与 API 一致性
- `main.py` 中存在 `include_router` 重复注册（`fund.legacy_router`、`watchlist.router`）问题，易导致维护混乱和潜在路由冲突。
- `/api/v1/quote/{ticker}` 在错误分支直接返回 200 + error dict，和 REST 常见语义（4xx/5xx）不一致，不利于前端统一错误处理。
- CORS 当前 `allow_origins=["*"]` 且 `allow_credentials=True`，生产环境存在安全风险。

#### B. 共识引擎（核心价值模块）
- 目前多模型流程是串行调用（Bull→Bear→Judge，且多 provider 循环串行），可用但延迟线性增长。
- 输出解析依赖文本正则，鲁棒性有限；注释也已标注“生产应使用 JSON mode”。
- 同步版与流式版重复了较多上下文构建逻辑，后续易出现功能漂移。

#### C. 前端与配置管理
- 前端 API URL 基于 `window.location.hostname:8000` 推断，适合局域网开发，但在多环境（代理、网关、HTTPS）场景可运维性偏弱。
- 设置存储采用 Zustand persist，API Key 明文保存在 `localStorage`，符合“本地优先”但需要明确 XSS 防护与风险提示。

#### D. 测试与治理
- 仓库有多份脚本化测试/调试文件，但缺少统一测试组织（如 `tests/` 目录规范、CI 门禁、覆盖率目标）。
- 版本与发布治理薄弱：缺少迁移策略、变更日志自动化、稳定分支策略说明。

---

## 3. 完整优化方案（按优先级）

## P0（必须立即执行，稳定性与安全）- 预计 2~4 周

### 3.1 API 语义收敛（Week 1）✅ 已完成

**统一错误码映射：**

| HTTP 状态码 | 场景 | 示例 |
|-------------|------|------|
| 400 | 参数错误 | 无效的 ticker 格式 |
| 404 | 未找到资产 | 股票代码不存在 |
| 502 | 上游数据源失败 | yfinance/AkShare 超时 |
| 500 | 内部错误 | 未捕获异常 |

**统一响应协议：** `{code, message, data, trace_id}` ✅

**涉及文件：**
- `app/models/response.py` - ✅ 新建：统一响应模型
- `app/middleware/trace_id.py` - ✅ 新建：TraceId middleware
- `app/routers/quote.py` - ✅ 更新：修改错误返回

### 3.2 安全基线（Week 1~2）✅ 部分完成

**修复清单：**
- [x] CORS 白名单环境变量化（`.env.example`）
- [ ] 关闭生产 debug 日志中的敏感上下文打印
- [x] 增加请求级 `trace_id`（使用 middleware）
- [x] 速率限制（使用 `slowapi`，关键接口 5~60 次/分）

### 3.3 关键缺陷修复（Week 2~3）✅ 已完成

| 缺陷 | 优先级 | 修复方案 | 状态 |
|------|--------|----------|------|
| 重复 router 注册 | 高 | 清理 `main.py` 中的重复 `include_router` | ✅ |
| 外部 API 无超时 | 高 | 添加 `timeout=30.0` (LLM) | ✅ |
| SSE 无心跳 | 中 | 每 15s 发送 `:ping` 事件 | 待实施 (P1) |
| 无重试机制 | 中 | 使用 `tenacity` 库实现指数退避 | ✅ |

---

## P1（1~2 个月，性能与可维护性）

### 3.4 共识引擎性能升级

**当前问题：** Bull - Bear - Judge 串行调用，延迟线性增长

**优化方案：**
- Bull/Bear 并发执行（`asyncio.gather`）
- 上下文构建拆分为独立 service（`ContextBuilder` 类）
- 采用结构化输出（JSON mode / function calling）替代正则解析

**预期收益：** 分析延迟降低 40~50%

### 3.5 数据与缓存策略

**推荐技术栈：** `cachetools`（内存缓存）或 Redis（分布式场景）

| 数据类型 | TTL | 缓存策略 |
|----------|-----|----------|
| 实时行情 | 5~30s | LRU，支持强制刷新 |
| 基本面数据 | 1~6 小时 | 定时刷新 |
| 新闻/搜索 | 5~15 分钟 | 按 query hash 缓存 |
| 分析结果 | 不缓存 | 每次实时计算 |

### 3.6 前后端契约治理

**工具链：**
- 后端：FastAPI 自动生成 OpenAPI spec (`/openapi.json`)
- 前端：使用 `openapi-typescript` 生成类型
- 禁止 `any` 外溢（eslint 规则 `@typescript-eslint/no-explicit-any`）
- 统一时间格式：ISO 8601，货币格式：`Intl.NumberFormat`

### 3.7 质量门禁

| 层级 | 工具 | 目标 |
|------|------|------|
| 后端单测 | pytest + httpx | 关键路径覆盖率 >= 60% |
| 前端检查 | eslint + tsc | 0 errors |
| 组件测试 | vitest / jest | 核心组件覆盖 |
| CI 门禁 | GitHub Actions | PR 必须通过 lint/test/build |

---

## P2（季度级，产品化与商业化能力）

### 3.8 平台化能力
- 用户体系（本地模式 + 云模式可切换）。
- 配置中心与审计日志。
- 模型路由策略：按任务/成本/延迟自动选模。

### 3.9 投资研究能力深化
- 组合层分析（相关性、暴露、压力测试）。
- 历史信号回测与“分析结论后验评估”。
- 因子化解释（估值、盈利、成长、情绪）结构化打分。

### 3.10 企业级部署能力
- 统一可观测性（日志、指标、追踪三件套）。
- 灰度发布 + 回滚预案。
- 配额与成本治理（token、API 费用看板）。

---

## 4. 未来开发路线图（建议）

## 阶段 I：4 周（稳定性冲刺）

| 周次 | 主要任务 | 交付物 |
|------|----------|--------|
| Week 1 | API 语义统一、重复路由修复 | 统一响应格式上线 |
| Week 2 | CORS 分环境、安全基线 | 安全配置完成 |
| Week 3 | SSE 稳定性优化 | 心跳/重连机制上线 |
| Week 4 | 集成测试、发布准备 | 发布 v0.2 稳定版 |

**里程碑指标（DoD）：**
- [ ] P0 缺陷清零
- [ ] 核心接口错误码规范覆盖 100%
- [ ] 核心链路自动化回归通过率 100%
- [ ] SSE 连接稳定性 > 99%

---

## 阶段 II：8 周（性能与质量）

| 周次 | 主要任务 | 负责模块 |
|------|----------|----------|
| Week 1~2 | 并发化共识引擎 | 后端 |
| Week 3~4 | 缓存层上线 | 后端 |
| Week 5~6 | OpenAPI client 生成 | 全栈 |
| Week 7~8 | 类型治理 + 联调测试 | 前端 |

**里程碑指标（DoD）：**
- [ ] 分析 P95 延迟下降 30% 以上
- [ ] SSE 中断率下降 50% 以上
- [ ] TypeScript `any` 使用量减少 80%
- [ ] 前后端类型错误清零

---

## 阶段 III：季度（产品化扩展）

| 功能模块 | 描述 | 商业价值 |
|----------|------|----------|
| 回测系统 | 历史信号验证 | 提升用户信任 |
| 组合分析 | 相关性、压力测试 | 专业用户需求 |
| 成本治理 | Token 用量看板 | 控制运营成本 |
| 模型路由 | 按任务自动选模 | 优化成本/效果 |
| 用户权限 | 团队协作支持 | 企业客户需求 |

**里程碑指标（DoD）：**
- [ ] 用户留存率提升 20%（由产品定义基线）
- [ ] 单次分析成本可视化
- [ ] 支持至少 3 种模型自动路由

---

## 5. 风险清单与应对

| 风险 | 影响 | 概率 | 应对策略 |
|------|------|------|----------|
| 外部数据源不稳定 | 高 | 中 | 多源 fallback + 熔断 + 缓存兜底 |
| LLM 输出漂移 | 中 | 高 | 结构化输出 + 校验器 + 回退模板 |
| 前端密钥风险 (XSS) | 高 | 低 | CSP、依赖审计、输入消毒、风险提示 |
| 研发效率下降 | 中 | 中 | 代码规范、脚手架、自动化发布 |
| API 成本超支 | 中 | 中 | 用量监控 + 预算告警 + 模型降级策略 |

---

## 6. 建议的组织与流程升级
- 采用“技术债看板 + 产品迭代看板”双轨。
- 每两周一次架构评审（含性能/成本复盘）。
- 每月一次“模型效果与成本”专项评估。
- 建立发布分级：patch（修复）/minor（功能）/major（破坏性变更）。

---

## 7. 结论

InvestLens 已具备较强的产品雏形和差异化能力（多模型共识 + 流式辩论 + 多市场数据），下一阶段应当从“功能可用”升级为“系统可靠、可运维、可规模化演进”。按照本文 P0→P1→P2 方案推进，可在 1~2 个季度内把项目提升到可持续迭代和可对外稳定交付的水平。
